<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DL.WMS — IA Automobile</title>
  <link rel="stylesheet" href="./assets/app.css" />
  <link rel="stylesheet" href="./assets/print.css" media="print" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b1220" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <a class="btn btn-ghost" href="./index.html">← Retour</a>
      <div class="stack">
        <h1 class="title">IA Automobile</h1>
        <div class="sub" id="kbStatus">KB: …</div>
      </div>
    </div>

    <div class="topbar-right">
      <span class="pill" id="netPill">…</span>
      <button id="btnInstall" class="btn btn-ghost" style="display:none;">Installer</button>
      <button id="btnReloadKB" class="btn btn-ghost">↻ KB</button>
    </div>
  </header>

  <main class="container">
    <nav class="tabs">
      <button class="tab active" data-tab="search">Recherche</button>
      <button class="tab" data-tab="guided">Diagnostic</button>
      <button class="tab" data-tab="fav">Favoris</button>
      <button class="tab" data-tab="settings">Paramètres</button>
    </nav>

    <section class="tabpane active" id="tab-search">
      <section class="card">
        <h2 class="h2">Question</h2>
        <label class="field">
          <span class="label">Ex: “P0171 Civic 2016: quoi vérifier?”</span>
          <textarea id="qInput" class="input textarea" rows="4" placeholder="Tape ici…"></textarea>
        </label>
        <div class="row">
          <button id="btnAnalyze" class="btn btn-primary">Analyser</button>
          <button id="btnClear" class="btn">Effacer</button>
          <button id="btnCopyAnswer" class="btn">Copier</button>
        </div>
      </section>

      <section class="card">
        <h2 class="h2">Filtres</h2>
        <div class="filters">
          <label class="field">
            <span class="label">Type</span>
            <select id="fType" class="input">
              <option value="">Tous</option>
              <option value="DTC">DTC</option>
              <option value="PROC">Procédure</option>
              <option value="TORQUE">Couple</option>
              <option value="FLUID">Fluide</option>
              <option value="PART">Pièce</option>
              <option value="NOTE">Note</option>
            </select>
          </label>
          <label class="field"><span class="label">Marque</span><input id="fMake" class="input" placeholder="Honda / Toyota / *" /></label>
          <label class="field"><span class="label">Modèle</span><input id="fModel" class="input" placeholder="Civic / RAV4 / *" /></label>
          <label class="field"><span class="label">Année</span><input id="fYear" class="input" inputmode="numeric" placeholder="2016" /></label>
          <label class="field"><span class="label">Moteur</span><input id="fEngine" class="input" placeholder="1.5T / 2.0 / *" /></label>
        </div>

        <div class="row">
          <label class="toggle">
            <input type="checkbox" id="optStrictSources" />
            <span>Répondre uniquement si sources trouvées</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="optShowConfidence" checked />
            <span>Afficher “Confiance”</span>
          </label>
        </div>
      </section>

      <section class="card">
        <h2 class="h2">Réponse</h2>
        <pre id="answerBox" class="answer" aria-live="polite"></pre>
        <div class="row">
          <button id="btnExportCSV" class="btn">Exporter CSV</button>
          <button id="btnExportPrintPack" class="btn">Exporter Print Pack</button>
          <button id="btnPrint" class="btn">Imprimer</button>
          <button id="btnFavorite" class="btn">★ Favori</button>
        </div>
      </section>

      <section class="card">
        <h2 class="h2">Résultats</h2>
        <div class="row">
          <input id="qQuick" class="input" placeholder="Recherche rapide KB…" />
          <button id="btnQuick" class="btn">Chercher</button>
        </div>
        <div id="results" class="results"></div>
      </section>

      <section class="card">
        <h2 class="h2">Historique</h2>
        <div class="row">
          <button id="btnClearHistory" class="btn btn-ghost">Vider historique</button>
        </div>
        <div id="history" class="history"></div>
      </section>
    </section>

    <section class="tabpane" id="tab-guided">
      <section class="card">
        <h2 class="h2">Diagnostic guidé</h2>
        <p class="muted">Choisis un scénario. L’app te guide (questions → hypothèses → tests → rapport).</p>
        <div class="row">
          <select id="flowSelect" class="input"></select>
          <button id="btnStartFlow" class="btn btn-primary">Démarrer</button>
          <button id="btnResetFlow" class="btn">Réinitialiser</button>
        </div>
      </section>

      <section class="card">
        <h2 class="h2">Assistant</h2>
        <div id="flowUI" class="flow"></div>
        <div class="row">
          <button id="btnFlowExport" class="btn">Exporter rapport (CSV)</button>
          <button id="btnFlowFavorite" class="btn">★ Favori</button>
        </div>
      </section>
    </section>

    <section class="tabpane" id="tab-fav">
      <section class="card">
        <h2 class="h2">Favoris</h2>
        <div class="row">
          <button id="btnExportFav" class="btn">Exporter favoris (JSON)</button>
          <button id="btnClearFav" class="btn btn-ghost">Vider favoris</button>
        </div>
        <div id="favList" class="history"></div>
      </section>
    </section>

    <section class="tabpane" id="tab-settings">
      <section class="card">
        <h2 class="h2">Import KB</h2>
        <p class="muted">JSON compatible auto_kb.json. Stocké localement dans le navigateur.</p>
        <div id="dropZone" class="dropzone">Dépose ton fichier KB JSON ici</div>

        <div class="row">
          <button id="btnResetToBundled" class="btn btn-ghost">Revenir à la KB incluse</button>
          <button id="btnClearLocalKB" class="btn btn-ghost">Supprimer KB locale</button>
        </div>

        <hr class="sep" />

        <h3 class="h3">Import Excel (optionnel)</h3>
        <p class="muted">Nécessite vendor/xlsx.full.min.js (SheetJS). Convertit en JSON puis sauvegarde KB locale.</p>
        <input type="file" id="excelFile" accept=".xlsx,.xls" class="input" />
        <div class="row">
          <button id="btnImportExcel" class="btn">Importer Excel → KB</button>
        </div>

        <hr class="sep" />

        <h3 class="h3">PWA / Offline</h3>
        <p class="muted">Service Worker + cache. Utile pour iPhone en mode terrain.</p>
        <div class="row">
          <button id="btnPwaRefresh" class="btn btn-ghost">Mettre à jour cache</button>
          <button id="btnPwaClear" class="btn btn-ghost">Vider cache</button>
        </div>
      </section>

      <section class="card">
        <h2 class="h2">Qualité & Sécurité</h2>
        <ul class="list">
          <li>Affiche toujours les Sources (IDs).</li>
          <li>Si aucune source: proposer questions de clarification ou refuser (mode strict).</li>
          <li>Évite les instructions dangereuses (ex: airbag, HV, fuel). Ajoute avertissement.</li>
        </ul>
      </section>
    </section>
  </main>

  <!-- <script src="./vendor/xlsx.full.min.js"></script> -->

  <script src="./js/utils.js"></script>
  <script src="./js/kb_store.js"></script>
  <script src="./js/kb_validate.js"></script>
  <script src="./js/search_engine.js"></script>
  <script src="./js/export_report.js"></script>
  <script src="./js/guided_diag.js"></script>
  <script src="./js/pwa.js"></script>
  <script src="./js/ia_auto.js"></script>
</body>
</html>
